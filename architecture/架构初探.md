### 架构初探

#### 01.什么是架构

##### 1.1.单机

软件系统需要具备对外提供服务，单机，就是把所有功能都实现在一个进程里，并部署在一台机器上

**优点**：

- 简单

**问题**：

- 运维需要停服

##### 1.2.单体、垂直应用|垂直切分

垂直应用架构：按应用垂直切分的单体

**优点**：

- 水平扩容
- 运维不需要停服

**问题**：

- 职责太多，开发效率不高
- 爆炸半径大

##### 1.3.SOA、微服务|水平切分

SOA：

- 将应用的不同功能单元抽象为服务
- 定义服务之间的通信标准

> 微服务架构：SOA的去中心化演进方向

**问题**：

- 数据一致性
- 高可用性
- 治理
- 解耦 vs 过微

#### 02.企业级后端架构剖析

##### 2.1.云计算

**云计算**：是指通过软件自动化管理，提供计算资源的服务网络，是现代互联网大规模熟悉分析和存储的基石。

基础：

- 虚拟化技术
- 编排方案

架构：

- IaaS(Infrastructure基础设施)
- Paas(Platform平台)
- Saas(Software软件)
- FaaS(Function功能)

##### 2.2.云原生

云原生技术为组织在公有云、自由云、混合云等新型的动态环境中，构建和运行可弹性拓展的应用提供了可能。

云原生包括了：

- 弹性资源：1.虚拟化容器；2.快速扩缩容
- 微服务架构：1.业务功能单元解耦；2.统一的通信标准
- DevOps：1.敏捷开发；2.CI/CD
- 服务网络：1.业务与治理解耦；2.异构系统的治理统一化；3.复杂治理能力

###### 2.2.1.弹性计算资源

弹性计算资源类型：

- 服务资源调度
  - 微服务
  - 大服务
- 计算资源调度
  - 在线
  - 离线
- 消息队列
  - 在线
  - 离线



###### 2.2.2.弹性存储资源

弹性存储资源类型：

- 经典
- 关系型数据库
- 元数据
- NoSQL

###### 2.2.3.DevOps

**DevOps**是云原生时代软件交付的利器，贯穿整个软件开发周期。

结合自动化流程，提高软件开发、交付效率

###### 2.2.4.微服务架构

**通信标准**：

- HTTP(RESTful API)
- RPC(Thrift， gRPC)

微服务中间件RPC vs HTTP:

- 性能
- 服务治理
- 协议可解释性

云原生场景下，微服务大可不必在业务逻辑中实现符合通信标准的交互逻辑，而是交给框架来做

###### 2.2.5.服务网格

服务网格：

- 微服务之间通讯的中间层
- 高性能网络代理
- 业务代码与治理解耦

相较于RPC/HTTP框架：

- 异构系统治理统一化
- 与业务进程解耦，生命周期易管理

#### 03.企业级后端架构的挑战
挑战：

- 基础设施层面
  - 物理资源是有限的
    - 机器
    - 带宽
  - 资源利用率受制于部署服务
- 用户层面
  - 网络通信开销较大
  - 网络抖动导致运维成本提高
  - 异构环境下，不同实例资源水位不均

##### 3.1.离在线资源并池

核心收益：

- 降低物理资源成本
- 提供更多的弹性资源，增加收入

解决思路：`离在线资源并池`

在线业务的特点

- IO密集型为主
- 潮汐性、实时性

离线业务的特点

- 计算密集型占多数
- 非实时性

##### 3.2.自动扩缩容

核心收益：

- 降低业务成本

解决思路：**自动扩缩容**

- 利用在线业务潮汐性自动扩缩容

##### 3.3.微服务亲合性部署

核心收益：

- 降低业务成本
- 提高服务可用性

解决思路：**微服务亲合性部署**

- 将满足亲合性条件的容器调度到一台宿主机
- 微服务中间件与服务网格通过共享内存通信
- 服务网格控制面实施灵活、动态的流量调度

##### 3.4.流量治理

核心收益：

- 提高微服务调用容错性
- 容灾
- 进一步提高开发效率，DevOps发挥到极致

解决思路：**基于微服务中间件 & 服务网格的流量治理**

- 熔断、重试
- 单元化
- 复杂环境(功能、预览)的流量调度

##### 3.5.CPU水位负载均衡

核心收益：

- 打平异构环境算力差异
- 为自动扩缩容提供正向输入

解决思路：**CPU水位负载均衡**

- IaaS
  - 提供资源探针
- 服务网格
  - 动态负载均衡

#### 04.后端架构实战

**输入：**

- 服务网格数据面
  - 支持带权重的负载均衡策略
- 注册中心存储了所有容器的权重信息
- 宿主机能提供
  - 容器的资源使用情况
  - 物理资源信息

**关键点**：

- 紧急回滚能力
- 大规模
- 极端场景

##### 4.1.自适应静态权重

**方案**:

- 采集宿主机物理资源信息
- 调整容器注册的权重

**优势**：

- 复杂度低
- 完全分布式，可用性高
- 微服务中间件无适配成本

![image-20230131181147753](https://raw.githubusercontent.com/moon-xuans/mediaImage/main/2023/image-20230131181147753.png)

##### 4.2.自适应动态权重Alpha

**方案**：

- 容器动态权重的自适应调整
- 服务网格的服务发现 & 流量调度能力

**演进方向**：

- 解决无法紧急回滚的问题
- 运行时权重自适应

**缺点**：

- 过度流量倾斜会有异常情况

![image-20230131181524008](https://raw.githubusercontent.com/moon-xuans/mediaImage/main/2023/image-20230131181524008.png)

 ##### 4.3.自适应动态权重Beta

**方案**：

- 服务网格上报RPC指标

**演进方向**：

- 极端场景的处理成为可能

**缺点**：

- 时序数据库压力较大
- 动态权重决策中心职责越来越多，迭代 -> 变更 -> 风险

![image-20230131211448739](https://raw.githubusercontent.com/moon-xuans/mediaImage/main/2023/image-20230131211448739.png)

##### 4.4.自适应动态权重Release

演进方向：

- 微服务化
- 引入消息队列削峰、解耦
- 离在线链路切分
- 梳理强弱依赖

![image-20230131211622991](https://raw.githubusercontent.com/moon-xuans/mediaImage/main/2023/image-20230131211622991.png)
